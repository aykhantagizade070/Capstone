<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardian</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            margin: 0;
            background: #050816;
            color: #e4e7f5;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        #app-shell {
            display: none; /* hidden until we know user is authenticated */
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            flex-shrink: 0;
            min-height: 100vh;
            background: #111827;
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h1 {
            font-size: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #334155;
        }

        .sidebar nav ul {
            list-style: none;
        }

        .sidebar nav ul li {
            margin-bottom: 10px;
        }

        .sidebar nav ul li a {
            color: #cbd5e1;
            text-decoration: none;
            display: block;
            padding: 10px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .sidebar nav ul li a:hover,
        .sidebar nav ul li a.active {
            background-color: #334155;
            color: white;
        }

        /* Main content */
        .main-content {
            flex: 1;
            padding: 24px 32px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            background-color: #1e293b;
            min-height: 100vh;
        }

        /* Remove width constraints from inner wrappers */
        .main-shell,
        .main-inner,
        .dashboard-container,
        .content-inner {
            width: 100%;
            max-width: none;
            margin: 0;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-header h2 {
            font-size: 28px;
            color: #e2e8f0;
        }

        /* Tab content sections */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Summary cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: #334155;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #475569;
        }

        .card h3 {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card .value {
            font-size: 32px;
            font-weight: bold;
            color: #e2e8f0;
        }

        .card.alert .value {
            color: #dc2626;
        }

        .card.high-risk .value {
            color: #ea580c;
        }

        .card.sensitive .value {
            color: #7c3aed;
        }

        /* Charts section */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: #334155;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #475569;
        }

        .chart-card {
            height: 320px;
            max-height: 320px;
            display: flex;
            flex-direction: column;
        }

        .chart-card canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .chart-container h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #e2e8f0;
        }

        /* Filters */
        .filters {
            background: #334155;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #475569;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters label {
            font-size: 14px;
            color: #cbd5e1;
            font-weight: 500;
        }

        .filters select,
        .filters input {
            padding: 8px 12px;
            border: 1px solid #475569;
            border-radius: 6px;
            font-size: 14px;
            background-color: #1e293b;
            color: #e2e8f0;
        }

        .filters select:focus,
        .filters input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .filters input[type="text"] {
            flex: 1;
            min-width: 200px;
        }

        /* Events table */
        .table-container {
            background: #334155;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #475569;
            overflow-x: auto;
        }

        .table-container h3 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #e2e8f0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table thead {
            background-color: #1e293b;
        }

        table th {
            text-align: left;
            padding: 12px;
            font-size: 12px;
            text-transform: uppercase;
            color: #94a3b8;
            font-weight: 600;
            border-bottom: 2px solid #475569;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #475569;
            font-size: 14px;
            color: #e2e8f0;
        }

        table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        table tbody tr:hover {
            background-color: #475569;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.severity-low {
            background-color: #dcfce7;
            color: #166534;
        }

        .badge.severity-medium {
            background-color: #fef3c7;
            color: #92400e;
        }

        .badge.severity-high {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .badge.alert {
            background-color: #dc2626;
            color: white;
        }

        .badge.classification-public {
            background-color: #e0e7ff;
            color: #3730a3;
        }

        .badge.classification-internal {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .badge.classification-private {
            background-color: #fce7f3;
            color: #9f1239;
        }

        .badge.classification-secret {
            background-color: #7c3aed;
            color: white;
        }

        .badge.badge-warning {
            background-color: #fef3c7;
            color: #92400e;
        }

        /* Admin Approval Panel */
        .admin-approval-panel {
            margin-top: 1.5rem;
            padding: 1rem 1.2rem;
            border-radius: 0.75rem;
            background: #fff7cc;
            color: #3b2f00;
            font-size: 0.9rem;
        }

        .admin-approval-panel h4 {
            margin: 0 0 0.5rem 0;
            color: #3b2f00;
        }

        .admin-approval-panel p {
            margin: 0.5rem 0;
            color: #3b2f00;
        }

        .admin-approval-panel input {
            width: 100%;
            margin-top: 0.5rem;
            padding: 0.4rem 0.6rem;
            border-radius: 0.5rem;
            border: 1px solid #e0cf7a;
            background: #fffdf0;
            color: #111827;
        }

        .error-message {
            margin-top: 0.5rem;
            color: #f97373;
        }

        .modal-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: #10b981;
            color: white;
        }

        .btn-primary:hover {
            background-color: #059669;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.hidden {
            display: none;
        }

        .modal-backdrop {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
        }

        /* Admin approval modal specific styles */
        #admin-approval-modal .modal-content {
            max-width: 500px;
        }

        .modal-meta {
            color: #cbd5e1;
            font-size: 0.9rem;
            margin: 1rem 0;
        }

        .modal-label {
            display: block;
            margin: 1rem 0 0.5rem 0;
            color: #e2e8f0;
            font-weight: 500;
        }

        .modal-label input {
            width: 100%;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border: 1px solid #475569;
            border-radius: 6px;
            background-color: #1e293b;
            color: #e2e8f0;
            font-size: 14px;
        }

        .modal-error {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #7f1d1d;
            color: #fca5a5;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .btn-secondary {
            padding: 0.75rem 1.5rem;
            background-color: #64748b;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background-color: #475569;
        }

        .modal-content {
            background: #334155;
            border-radius: 8px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid #475569;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(5, 8, 22, 0.88);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }

        .modal-backdrop.hidden {
            display: none;
        }

        /* Admin approval modal - dedicated classes to avoid conflicts */
        .admin-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(5, 8, 22, 0.92);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .admin-modal-backdrop.hidden {
            display: none;
        }

        .admin-modal-card {
            background: #1f2235;
            padding: 1.75rem 2rem;
            border-radius: 16px;
            width: 420px;
            max-width: 90vw;
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
            position: relative;
            z-index: 2001;
        }

        .admin-modal-title {
            margin: 0 0 0.75rem 0;
            color: #e2e8f0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .admin-modal-text {
            margin: 0 0 1rem 0;
            color: #cbd5e1;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .admin-modal-field {
            margin-top: 1rem;
        }

        .admin-modal-field label {
            display: block;
            margin-bottom: 0.35rem;
            font-size: 0.85rem;
            color: #aab3cc;
            font-weight: 500;
        }

        .admin-modal-field input {
            width: 100%;
            padding: 0.6rem 0.75rem;
            border-radius: 8px;
            border: 1px solid #3b3f58;
            background: #151728;
            color: #fff;
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        .admin-modal-field input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .admin-modal-actions {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .admin-modal-error {
            margin-top: 0.5rem;
            color: #f87171;
            font-size: 0.8rem;
            min-height: 1.2rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #475569;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #e2e8f0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #1e293b;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        /* AI Remediation Card */
        .ai-remediation-card {
            background: #fef9c3;
            color: #713f12;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.25rem;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            max-width: 100%;
        }

        .ai-remediation-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .ai-remediation-icon {
            font-size: 1.2rem;
        }

        .ai-remediation-text {
            margin: 0;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .detail-section h3 {
            font-size: 16px;
            color: #e2e8f0;
            margin-bottom: 10px;
        }

        .detail-section p,
        .detail-section ul {
            color: #cbd5e1;
            font-size: 14px;
            line-height: 1.6;
        }

        .detail-section ul {
            list-style: none;
            padding-left: 0;
        }

        .detail-section ul li {
            padding: 4px 0;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .error {
            background-color: #7f1d1d;
            color: #fca5a5;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #991b1b;
        }


        /* Login overlay */
        #login-overlay {
            position: fixed;
            inset: 0;
            display: flex; /* visible by default, until we detect a valid session */
            align-items: center;
            justify-content: center;
            background: #050816; /* full dark background */
            z-index: 1000;
        }

        .login-box {
            background: #334155;
            border-radius: 12px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid #475569;
        }

        .login-box h1 {
            color: #e2e8f0;
            margin-bottom: 30px;
            text-align: center;
            font-size: 24px;
        }

        .login-box input[type="text"],
        .login-box input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #475569;
            border-radius: 6px;
            background-color: #1e293b;
            color: #e2e8f0;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .login-box input[type="text"]:focus,
        .login-box input[type="password"]:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .login-box button {
            width: 100%;
            padding: 12px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .login-box button:hover {
            background-color: #2563eb;
        }

        .login-error {
            color: #fca5a5;
            margin-top: 10px;
            font-size: 14px;
            text-align: center;
        }

        /* Timeline styles */
        .timeline-container {
            background: #334155;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #475569;
            margin-bottom: 20px;
        }

        .timeline-container h3 {
            color: #e2e8f0;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .timeline {
            position: relative;
            padding-left: 180px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 90px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #475569;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 25px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: flex-start;
        }

        .timeline-item:hover {
            opacity: 0.8;
        }

        .timeline-left {
            position: absolute;
            left: -180px;
            width: 160px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timeline-timestamp {
            color: #94a3b8;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #334155;
            flex-shrink: 0;
            position: relative;
            left: -2px;
        }

        .timeline-item.severity-low .timeline-dot {
            background-color: #10b981;
        }

        .timeline-item.severity-medium .timeline-dot {
            background-color: #f59e0b;
        }

        .timeline-item.severity-high .timeline-dot {
            background-color: #ef4444;
        }

        .timeline-item.severity-critical .timeline-dot {
            background-color: #dc2626;
        }

        .timeline-right {
            flex: 1;
            background: #1e293b;
            border-radius: 6px;
            padding: 15px;
            border-left: 3px solid transparent;
            transition: border-color 0.2s;
        }

        .timeline-item.severity-low .timeline-right {
            border-left-color: #10b981;
        }

        .timeline-item.severity-medium .timeline-right {
            border-left-color: #f59e0b;
        }

        .timeline-item.severity-high .timeline-right {
            border-left-color: #ef4444;
        }

        .timeline-item.severity-critical .timeline-right {
            border-left-color: #dc2626;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .timeline-event-type {
            color: #e2e8f0;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
        }

        .timeline-body {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .timeline-path {
            color: #cbd5e1;
            font-size: 13px;
            font-family: monospace;
            flex: 1;
            min-width: 200px;
            word-break: break-all;
        }

        .timeline-meta {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .timeline-risk-score {
            color: #f59e0b;
            font-weight: 600;
            font-size: 13px;
        }

        /* Content pages */
        .content-page {
            background: #334155;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid #475569;
            margin-bottom: 20px;
        }

        .content-page h2 {
            color: #e2e8f0;
            margin-bottom: 20px;
        }

        .content-page p {
            color: #cbd5e1;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .content-page code {
            background: #1e293b;
            padding: 2px 6px;
            border-radius: 4px;
            color: #60a5fa;
            font-family: 'Courier New', monospace;
        }

        .content-page pre {
            background: #1e293b;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            border: 1px solid #475569;
        }

        .content-page pre code {
            background: none;
            padding: 0;
            color: #e2e8f0;
        }
    </style>
</head>
<body>
    <!-- App Shell (hidden until login) -->
    <div id="app-shell" class="app-shell">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h1>Guardian</h1>
            <nav>
                <ul>
                    <li><a href="#" class="active" data-page="dashboard">Dashboard</a></li>
                    <li><a href="#" data-page="events">Events</a></li>
                    <li><a href="#" data-page="mitre">MITRE</a></li>
                    <li><a href="#" data-page="agents">Agents</a></li>
                    <li><a href="#" data-page="help">Help</a></li>
                    <li><a href="#" data-page="about">About</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Tab -->
            <div class="tab-content active" id="tab-dashboard">
                <div class="page-header">
                    <h2>Dashboard</h2>
                </div>

                <!-- Summary Cards -->
                <div class="cards-grid">
                <div class="card">
                    <h3>Total Events</h3>
                    <div class="value" id="total-events">-</div>
                </div>
                <div class="card alert">
                    <h3>Total Alerts</h3>
                    <div class="value" id="total-alerts">-</div>
                </div>
                <div class="card high-risk">
                    <h3>High Risk Events</h3>
                    <div class="value" id="high-risk-events">-</div>
                </div>
                <div class="card sensitive">
                    <h3>Sensitive Events</h3>
                    <div class="value" id="sensitive-events">-</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="dashboard-grid">
                <div class="card chart-card">
                    <h3>Risk Distribution</h3>
                    <canvas id="risk-pie-chart"></canvas>
                </div>
                <div class="card chart-card">
                    <h3>Events by Type</h3>
                    <canvas id="event-type-chart"></canvas>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters">
                <label for="severity-filter">Severity:</label>
                <select id="severity-filter">
                    <option value="">All</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>

                <label for="classification-filter">Classification:</label>
                <select id="classification-filter">
                    <option value="">All</option>
                    <option value="public">Public</option>
                    <option value="internal">Internal</option>
                    <option value="private">Private</option>
                    <option value="secret">Secret</option>
                </select>

                <label for="path-search">Search Path:</label>
                <input type="text" id="path-search" placeholder="Filter by path...">
            </div>

            <!-- Pending Admin Approvals -->
            <div class="table-container" id="pending-approvals-section" style="display: none; margin-bottom: 20px; background-color: #78350f; border-left: 4px solid #f59e0b;">
                <h3 style="color: #fbbf24;">⚠️ Pending Admin Approvals</h3>
                <p style="color: #78350f; margin-bottom: 15px;">The following events require admin approval:</p>
                <div id="pending-approvals-error"></div>
                <table id="pending-approvals-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Type</th>
                            <th>Severity</th>
                            <th>Path</th>
                            <th>Classification</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="pending-approvals-tbody">
                        <tr>
                            <td colspan="6" class="loading">Loading pending approvals...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Events Table -->
            <div class="table-container">
                <h3>Recent Events</h3>
                <div id="table-error"></div>
                <table id="events-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Type</th>
                            <th>Severity</th>
                            <th>Risk Score</th>
                            <th>Path</th>
                            <th>Classification</th>
                            <th>Alert</th>
                        </tr>
                    </thead>
                    <tbody id="events-tbody">
                        <tr>
                            <td colspan="7" class="loading">Loading events...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            </div>

            <!-- Events Tab -->
            <div class="tab-content" id="tab-events">
                <div class="page-header">
                    <h2>Events</h2>
                </div>
                
                <!-- Attacker Timeline View -->
                <div class="timeline-container" id="timeline-container">
                    <h3>Attacker Timeline</h3>
                    <div id="timeline-error"></div>
                    <div class="timeline" id="timeline">
                        <div class="loading">Loading timeline...</div>
                    </div>
                </div>

                <!-- Events Table View (hidden by default, can be shown with filters) -->
                <div class="filters" id="events-filters" style="display: none;">
                    <label for="events-severity-filter">Severity:</label>
                    <select id="events-severity-filter">
                        <option value="">All</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                    <label for="events-classification-filter">Classification:</label>
                    <select id="events-classification-filter">
                        <option value="">All</option>
                        <option value="public">Public</option>
                        <option value="internal">Internal</option>
                        <option value="private">Private</option>
                        <option value="secret">Secret</option>
                    </select>
                    <label for="events-path-search">Search Path:</label>
                    <input type="text" id="events-path-search" placeholder="Filter by path...">
                    <label for="events-limit">Limit:</label>
                    <select id="events-limit">
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                    </select>
                </div>
                <div class="table-container" id="events-table-container" style="display: none;">
                    <h3>All Events</h3>
                    <div id="events-table-error"></div>
                    <table id="events-full-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Type</th>
                                <th>Severity</th>
                                <th>Risk Score</th>
                                <th>Path</th>
                                <th>Classification</th>
                                <th>Alert</th>
                            </tr>
                        </thead>
                        <tbody id="events-full-tbody">
                            <tr>
                                <td colspan="7" class="loading">Loading events...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- MITRE Tab -->
            <div class="tab-content" id="tab-mitre">
                <div class="page-header">
                    <h2>MITRE ATT&CK Analysis</h2>
                </div>
                <div class="table-container">
                    <h3>MITRE Techniques and Tactics</h3>
                    <div id="mitre-error"></div>
                    <table id="mitre-table">
                        <thead>
                            <tr>
                                <th>Technique/Tactic</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody id="mitre-tbody">
                            <tr>
                                <td colspan="2" class="loading">Loading MITRE data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Agents Tab -->
            <div class="tab-content" id="tab-agents">
                <div class="content-page">
                    <h2>Agents</h2>
                    <p><strong>Deployment Type:</strong> Single-agent deployment</p>
                    <p><strong>Hostname:</strong> <span id="agent-hostname">Loading...</span></p>
                    <p><strong>Status:</strong> <span style="color: #10b981;">● Active</span></p>
                </div>
            </div>

            <!-- Help Tab -->
            <div class="tab-content" id="tab-help">
                <div class="content-page">
                    <h2>Help</h2>
                    <h3>Running the Agent</h3>
                    <p>To start the FIM agent, use the following command:</p>
                    <pre><code>python -m fim_agent.cli.main --config config\config.yaml run-agent</code></pre>
                    
                    <h3>Building Baseline</h3>
                    <p>Before running the agent, initialize the baseline:</p>
                    <pre><code>python -m fim_agent.cli.main --config config\config.yaml init-baseline</code></pre>
                    
                    <h3>Viewing Timeline</h3>
                    <p>To view the event timeline from the command line:</p>
                    <pre><code>python -m fim_agent.cli.main --config config\config.yaml timeline</code></pre>
                    
                    <h3>Dashboard</h3>
                    <p>Start the web dashboard with:</p>
                    <pre><code>python -m fim_agent.cli.main --config config\config.yaml serve-web</code></pre>
                    
                    <h3>Configuration</h3>
                    <p>Edit <code>config/config.yaml</code> to customize monitored directories, exclusions, and alert thresholds.</p>
                </div>
            </div>

            <!-- About Tab -->
            <div class="tab-content" id="tab-about">
                <div class="content-page">
                    <h2>About FIM Agent</h2>
                    <p><strong>File Integrity Monitoring (FIM) Agent</strong> is a real-time file integrity monitoring system designed for security and compliance.</p>
                    
                    <h3>Features</h3>
                    <ul style="color: #cbd5e1; line-height: 1.8;">
                        <li>Real-time file system monitoring</li>
                        <li>SHA-256 hash-based integrity verification</li>
                        <li>Content classification (public/internal/private/secret)</li>
                        <li>Risk scoring and AI-driven recommendations</li>
                        <li>MITRE ATT&CK technique mapping</li>
                        <li>Admin approval workflow for sensitive files</li>
                        <li>SIEM-friendly JSON logging (Wazuh compatible)</li>
                        <li>Web dashboard for visualization and management</li>
                    </ul>
                    
                    <h3>Project</h3>
                    <p>This is a capstone project demonstrating real-time file integrity monitoring capabilities.</p>
                    
                    <h3>Version</h3>
                    <p>1.0.0</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Event Detail Modal -->
    <div class="modal" id="event-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Event Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="event-details">
                <div class="loading">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Admin Approval Modal -->
    <div id="admin-approval-modal" class="admin-modal-backdrop hidden">
        <div class="admin-modal-card">
            <h2 class="admin-modal-title">Admin approval required</h2>
            <p id="admin-approval-text" class="admin-modal-text">
                Sensitive file modification detected. Enter admin password to approve this change.
            </p>
            <div class="admin-modal-field">
                <label for="admin-approval-password">Admin password</label>
                <input type="password" id="admin-approval-password" />
            </div>
            <div id="admin-approval-error" class="admin-modal-error"></div>
            <div class="admin-modal-actions">
                <button id="admin-approval-cancel" class="btn-secondary">Later</button>
                <button id="admin-approval-submit" class="btn-primary">Approve</button>
            </div>
        </div>
    </div>

    <!-- Login Overlay (sits on top) -->
    <div id="login-overlay">
        <div class="login-box">
            <h1>Guardian Login</h1>
            <form id="login-form">
                <input type="text" id="login-username" placeholder="Username" autocomplete="username" />
                <input type="password" id="login-password" placeholder="Password" autocomplete="current-password" />
                <button type="submit">Sign in</button>
                <div id="login-error" class="login-error" style="display: none;"></div>
            </form>
        </div>
    </div>

    <script>
        // Global state
        let riskPieChart = null;
        let eventTypeChart = null;
        let currentEvent = null;

        // Global state for approval modal
        let currentApprovalEventId = null;
        let pendingAdminEvent = null;
        let refreshTimer = null;
        let pendingApprovalEvent = null;
        let approvalPollTimer = null;
        let currentFilterParams = "";

        // Events cache for filtering
        let eventsCache = [];

        // Login flow functions
        async function loadSummary() {
            const res = await fetch("/api/stats/summary", {
                credentials: "include",
            });
            if (!res.ok) return;
            const data = await res.json();
            // Reuse existing code that updates the summary cards
            if (typeof updateSummaryCards === 'function') {
                updateSummaryCards(data);
            }
        }

        async function loadRiskPie() {
            const res = await fetch("/api/stats/risk_pie", {
                credentials: "include",
            });
            if (!res.ok) return;
            const data = await res.json();
            // Reuse existing Chart.js code that renders the risk pie chart
            if (typeof renderRiskPieChart === 'function') {
                renderRiskPieChart(data);
            }
        }

        function getCurrentEventQuery() {
            const severity = document.getElementById("severity-filter")?.value || "";
            const classification = document.getElementById("classification-filter")?.value || "";
            const search = document.getElementById("path-search")?.value?.trim() || "";

            const params = new URLSearchParams();
            params.set("limit", "100");
            if (severity) params.set("severity", severity);
            if (classification) params.set("classification", classification);
            if (search) params.set("path_filter", search);
            return "?" + params.toString();
        }

        async function loadEvents(query) {
            const qs = query || getCurrentEventQuery() || "?limit=100";
            const res = await fetch("/api/events" + qs, { credentials: "include" });
            if (!res.ok) return;
            const data = await res.json();
            
            // Reuse existing code that fills the events table
            if (typeof renderEventsTable === 'function') {
                renderEventsTable(data);
            }

            // Note: Admin approval modal is now handled by pollPendingApprovals()
            // This keeps the separation of concerns - polling handles modal display
        }

        async function refreshDashboard() {
            await loadSummary();
            await loadRiskPie();
            await loadEvents();
        }

        async function initDashboard() {
            const shell = document.getElementById("app-shell");
            const overlay = document.getElementById("login-overlay");

            const res = await fetch("/api/stats/summary", {
                credentials: "include",
            });

            if (res.ok) {
                if (overlay) overlay.style.display = "none";
                if (shell) shell.style.display = "flex";

                await loadSummary();
                await loadRiskPie();
                await loadEvents();

                // Also load additional dashboard components if functions exist
                if (typeof loadEventTypeChart === 'function') {
                    await loadEventTypeChart();
                }
                if (typeof loadPendingApprovals === 'function') {
                    await loadPendingApprovals();
                }
                if (typeof setupFilters === 'function') {
                    setupFilters();
                }
                if (typeof setupTableClicks === 'function') {
                    setupTableClicks();
                }
                if (typeof setupTabNavigation === 'function') {
                    setupTabNavigation();
                }
                // Refresh pending approvals every 30 seconds
                if (typeof loadPendingApprovals === 'function') {
                    setInterval(loadPendingApprovals, 30000);
                }

                // Start auto-refresh timer
                if (!refreshTimer) {
                    refreshTimer = setInterval(() => {
                        refreshDashboard().catch(err => console.error("Auto-refresh failed", err));
                    }, 8000); // about every 8 seconds
                }

                // start polling for admin approvals every 5 seconds
                if (!approvalPollTimer) {
                    approvalPollTimer = setInterval(pollPendingApprovals, 5000);
                }
            } else {
                if (overlay) overlay.style.display = "flex";
                if (shell) shell.style.display = "none";
            }
        }

        async function handleLogin(event) {
            event.preventDefault();

            const usernameInput = document.getElementById("login-username");
            const passwordInput = document.getElementById("login-password");
            const errorBox = document.getElementById("login-error");

            const username = usernameInput ? usernameInput.value.trim() : "dashboard";
            const password = passwordInput ? passwordInput.value : "";

            if (!password) {
                if (errorBox) {
                    errorBox.style.display = "block";
                    errorBox.textContent = "Password is required";
                }
                return;
            }

            try {
                const res = await fetch("/api/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({ username, password }),
                });

                if (!res.ok) {
                    if (errorBox) {
                        errorBox.style.display = "block";
                        errorBox.textContent = "Invalid username or password";
                    }
                    return;
                }

                // Login ok: hide overlay, show dashboard, clear error, load data
                if (errorBox) {
                    errorBox.style.display = "none";
                    errorBox.textContent = "";
                }
                const overlay = document.getElementById("login-overlay");
                if (overlay) overlay.style.display = "none";
                const shell = document.getElementById("app-shell");
                if (shell) shell.style.display = "flex";

                await loadSummary();
                await loadRiskPie();
                await loadEvents();

                // Also load additional dashboard components if functions exist
                if (typeof loadEventTypeChart === 'function') {
                    await loadEventTypeChart();
                }
                if (typeof loadPendingApprovals === 'function') {
                    await loadPendingApprovals();
                }
                if (typeof setupFilters === 'function') {
                    setupFilters();
                }
                if (typeof setupTableClicks === 'function') {
                    setupTableClicks();
                }
                if (typeof setupTabNavigation === 'function') {
                    setupTabNavigation();
                }
                // Refresh pending approvals every 30 seconds
                if (typeof loadPendingApprovals === 'function') {
                    setInterval(loadPendingApprovals, 30000);
                }

                // Start auto-refresh timer if not already running
                if (!refreshTimer) {
                    refreshTimer = setInterval(() => {
                        refreshDashboard().catch(err => console.error("Auto-refresh failed", err));
                    }, 8000); // about every 8 seconds
                }

                // start polling for admin approvals every 5 seconds
                if (!approvalPollTimer) {
                    approvalPollTimer = setInterval(pollPendingApprovals, 5000);
                }
            } catch (err) {
                console.error("Login failed", err);
                if (errorBox) {
                    errorBox.style.display = "block";
                    errorBox.textContent = "Login error — see console for details";
                }
            }
        }

        // Handle MITRE "View Events" button clicks
        document.addEventListener("click", (e) => {
            const btn = e.target.closest("[data-mitre-tag]");
            if (!btn) return;
            const tag = btn.getAttribute("data-mitre-tag");
            showEventsWithMitreTag(tag);
        });

        function showAdminApprovalModal(event) {
            pendingApprovalEvent = event;
            const modal = document.getElementById("admin-approval-modal");
            const text = document.getElementById("admin-approval-text");

            if (text) {
                const sev = event.severity ? String(event.severity).toUpperCase() : "N/A";
                const risk = (event.risk_score !== null && event.risk_score !== undefined) ? event.risk_score : "N/A";
                text.textContent = `Private/sensitive file modified: ${event.path}\nSeverity: ${sev} | Risk score: ${risk}. Enter admin password to approve this change.`;
            }

            const pwd = document.getElementById("admin-approval-password");
            const err = document.getElementById("admin-approval-error");
            if (pwd) pwd.value = "";
            if (err) err.textContent = "";

            if (modal) modal.classList.remove("hidden");
            if (pwd) setTimeout(() => pwd.focus(), 0);
        }

        function hideAdminApprovalModal() {
            const modal = document.getElementById("admin-approval-modal");
            if (modal) modal.classList.add("hidden");
            pendingApprovalEvent = null;
            // Refresh pending list so "Later" immediately shows the event in Pending Admin Approvals
            if (typeof loadPendingApprovals === "function") {
                loadPendingApprovals().catch(() => {});
            }
        }

        async function pollPendingApprovals() {
            try {
                const res = await fetch(
                    "/api/events?requires_admin_approval=true&admin_approved=false&limit=1",
                    { credentials: "include" }
                );
                if (!res.ok) return;

                const data = await res.json();
                if (data.count > 0 && Array.isArray(data.events) && data.events.length > 0) {
                    const ev = data.events[0];

                    // avoid reopening the modal for the same event
                    if (!pendingApprovalEvent || pendingApprovalEvent.id !== ev.id) {
                        showAdminApprovalModal(ev);
                    }
                }
            } catch (err) {
                console.error("Error polling approvals", err);
            }
        }

        async function approveCurrentEvent() {
            const errorBox = document.getElementById("admin-approval-error");
            if (!pendingApprovalEvent) return;

            const pwdInput = document.getElementById("admin-approval-password");
            const password = pwdInput ? pwdInput.value.trim() : "";

            try {
                const res = await fetch(`/api/admin/approve/${pendingApprovalEvent.id}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({ password: password, approve: true }),
                });

                if (!res.ok) {
                    if (errorBox) errorBox.textContent = "Invalid admin password";
                    return;
                }

                hideAdminApprovalModal();

                // reload stats and events so the table + cards refresh
                await loadSummary();
                await loadRiskPie();
                await loadEvents(currentFilterParams || "");
                if (typeof loadPendingApprovals === "function") {
                    await loadPendingApprovals();
                }
            } catch (err) {
                console.error("Approval failed", err);
                if (errorBox) errorBox.textContent = "Approval error — check console";
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("login-form");
            if (form) {
                form.addEventListener("submit", handleLogin);
            }

            const approveBtn = document.getElementById("admin-approval-submit");
            const cancelBtn = document.getElementById("admin-approval-cancel");

            if (approveBtn) approveBtn.addEventListener("click", approveCurrentEvent);
            if (cancelBtn) cancelBtn.addEventListener("click", hideAdminApprovalModal);

            initDashboard();
        });

        // Load event type chart
        async function loadEventTypeChart() {
            const res = await fetch("/api/stats/summary", {
                credentials: "include",
            });
            if (!res.ok) return;
            const data = await res.json();
            renderEventTypeChart(data);
        }

        // Load pending admin approvals
        async function loadPendingApprovals() {
            try {
                const response = await fetch('/api/admin/pending?limit=10', {
                    credentials: "include"
                });
                if (response.status === 401) {
                    document.getElementById("login-overlay").style.display = "flex";
                    return;
                }
                if (!response.ok) return;
                const data = await response.json();
                
                const section = document.getElementById('pending-approvals-section');
                const tbody = document.getElementById('pending-approvals-tbody');
                tbody.innerHTML = '';

                if (data.events.length === 0) {
                    section.style.display = 'none';
                    return;
                }

                section.style.display = 'block';
                
                data.events.forEach(event => {
                    const row = document.createElement('tr');
                    const eid = event.id ?? event.event_id;
                    row.innerHTML = `
                        <td>${formatTimestamp(event.timestamp)}</td>
                        <td>${event.event_type}</td>
                        <td><span class="badge severity-${event.severity}">${event.severity}</span></td>
                        <td>${truncatePath(event.path)}</td>
                        <td>${event.content_classification ? 
                            `<span class="badge classification-${event.content_classification}">${event.content_classification}</span>` : 
                            '-'}</td>
                        <td></td>
                    `;

                    const actionsCell = row.lastElementChild;
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.textContent = "Review";
                    btn.setAttribute(
                        "style",
                        "padding: 6px 12px; background-color: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;"
                    );
                    btn.onclick = () => {
                        if (!eid) {
                            alert("Missing event id");
                            return;
                        }
                        openApprovalModal(eid, event.path, event.risk_score || 0);
                    };
                    if (actionsCell) actionsCell.appendChild(btn);

                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading pending approvals:', error);
                document.getElementById('pending-approvals-error').innerHTML = 
                    '<div class="error">Failed to load pending approvals</div>';
            }
        }

        // Open approval modal (Pending table "Review"): load full event detail, then reuse the existing Admin Approval Modal
        async function openApprovalModal(eventId, path, riskScore) {
            if (!eventId) {
                alert("Missing event id");
                return;
            }
            currentApprovalEventId = eventId;
            try {
                const res = await fetch(`/api/events/${eventId}`, { credentials: "include" });
                if (res.ok) {
                    const ev = await res.json();
                    showAdminApprovalModal(ev);
                    return;
                }
            } catch (err) {
                console.error("Failed to load event details for approval modal", err);
            }
            // Fallback: use row data
            showAdminApprovalModal({ id: eventId, path: path, risk_score: riskScore });
        }

        // Close approval modal
        function closeApprovalModal() {
            currentApprovalEventId = null;
            hideAdminApprovalModal();
        }

        // Submit approval/rejection
        async function submitApproval(approved) {
            if (!currentApprovalEventId) {
                return;
            }

            const errorBox = document.getElementById("admin-approval-error");
            const pwdInput = document.getElementById("admin-approval-password");
            const password = pwdInput ? pwdInput.value.trim() : "";
            if (!password) {
                if (errorBox) errorBox.textContent = "Please enter admin password";
                return;
            }

            try {
                const response = await fetch(`/api/admin/approve/${currentApprovalEventId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: "include",
                    body: JSON.stringify({
                        password: password,
                        approved: approved
                    })
                });

                if (!response.ok) {
                    if (errorBox) errorBox.textContent = "Invalid admin password";
                    return;
                }

                // Close modal
                closeApprovalModal();
                
                // Reload pending approvals and events
                loadPendingApprovals();
                loadEventsWithFilters();
            } catch (error) {
                console.error('Error approving event:', error);
                if (errorBox) errorBox.textContent = "Approval error — check console";
            }
        }

        // Close approval modal on outside click
        // (Old approval modal removed/unused; keep behavior via admin-approval-modal)

        // Update summary cards
        function updateSummaryCards(stats) {
            document.getElementById('total-events').textContent = stats.total_events || 0;
            document.getElementById('total-alerts').textContent = stats.total_alerts || 0;
            
            // Calculate high risk events (risk_score >= 60)
            const highRisk = Object.values(stats.counts_by_severity || {}).reduce((a, b) => a + b, 0);
            // For now, use high severity count as proxy
            document.getElementById('high-risk-events').textContent = stats.counts_by_severity?.high || 0;
            
            // Calculate sensitive events (private + secret)
            const sensitive = (stats.counts_by_classification?.private || 0) + 
                            (stats.counts_by_classification?.secret || 0);
            document.getElementById('sensitive-events').textContent = sensitive;
        }

        // Render risk pie chart
        function renderRiskPieChart(data) {
            const ctx = document.getElementById('risk-pie-chart').getContext('2d');
            
            if (riskPieChart) {
                riskPieChart.destroy();
            }

            const colors = {
                low: '#10b981',
                medium: '#f59e0b',
                high: '#ef4444',
                critical: '#dc2626'
            };

            riskPieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data).map(k => k.charAt(0).toUpperCase() + k.slice(1)),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: Object.keys(data).map(k => colors[k] || '#64748b')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#e2e8f0'
                            }
                        }
                    },
                    layout: {
                        padding: 10
                    }
                }
            });
        }

        // Render event type bar chart
        function renderEventTypeChart(stats) {
            const ctx = document.getElementById('event-type-chart').getContext('2d');
            
            if (eventTypeChart) {
                eventTypeChart.destroy();
            }

            const eventTypes = stats.counts_by_event_type || {};
            const labels = Object.keys(eventTypes);
            const values = Object.values(eventTypes);

            eventTypeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Event Count',
                        data: values,
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: { color: '#e2e8f0' },
                            grid: { display: false }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#1f2937' },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Render events table (extracted from loadEvents)
        function renderEventsTable(data) {
            const tbody = document.getElementById('events-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            if (data.events.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No events found</td></tr>';
                return;
            }

            data.events.forEach(event => {
                const row = document.createElement('tr');
                const needsApproval = event.requires_admin_approval === true && event.admin_approved === null;
                const approvalBadge = needsApproval ? '<span class="badge badge-warning">Needs approval</span>' : '';
                row.onclick = () => {
                    currentEvent = event;
                    showEventDetails(event.id);
                };
                row.innerHTML = `
                    <td>${formatTimestamp(event.timestamp)}</td>
                    <td>${event.event_type}</td>
                    <td><span class="badge severity-${event.severity}">${event.severity}</span></td>
                    <td>${event.risk_score !== null ? event.risk_score : '-'}</td>
                    <td>${truncatePath(event.path)}</td>
                    <td>${event.content_classification ? 
                        `<span class="badge classification-${event.content_classification}">${event.content_classification}</span>` : 
                        '-'}</td>
                    <td>${event.alert ? '<span class="badge alert">ALERT</span>' : ''} ${approvalBadge}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load events with filters (for dashboard tab)
        async function loadEventsWithFilters() {
            const severity = document.getElementById('severity-filter')?.value || '';
            const classification = document.getElementById('classification-filter')?.value || '';
            const pathSearch = document.getElementById('path-search')?.value || '';

            const params = new URLSearchParams({ limit: '100' });
            if (severity) params.append('severity', severity);
            if (classification) params.append('classification', classification);
            if (pathSearch) params.append('path_filter', pathSearch);

            try {
                const response = await fetch(`/api/events?${params}`, {
                    credentials: "include"
                });
                if (response.status === 401) {
                    document.getElementById("login-overlay").style.display = "flex";
                    return;
                }
                if (!response.ok) return;
                const data = await response.json();
                renderEventsTable(data);
            } catch (error) {
                console.error('Error loading events:', error);
                const tbody = document.getElementById('events-tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="7" class="error">Failed to load events</td></tr>';
                }
            }
        }

        // Setup filters
        function setupFilters() {
            const severityFilter = document.getElementById('severity-filter');
            const classificationFilter = document.getElementById('classification-filter');
            const pathSearch = document.getElementById('path-search');
            
            if (severityFilter) severityFilter.addEventListener('change', loadEventsWithFilters);
            if (classificationFilter) classificationFilter.addEventListener('change', loadEventsWithFilters);
            if (pathSearch) pathSearch.addEventListener('input', debounce(loadEventsWithFilters, 300));
            
            // Setup events tab filters
            setupEventsTabFilters();
        }

        // Setup table row clicks
        function setupTableClicks() {
            // Handled in loadEvents via row.onclick
        }

        // Show event details modal
        async function showEventDetails(eventId) {
            const modal = document.getElementById('event-modal');
            const details = document.getElementById('event-details');
            
            modal.classList.add('active');
            details.innerHTML = '<div class="loading">Loading event details...</div>';

            try {
                const response = await fetch(`/api/events/${eventId}`, {
                    credentials: "include"
                });
                if (response.status === 401) {
                    document.getElementById("login-overlay").style.display = "flex";
                    closeModal();
                    return;
                }
                if (!response.ok) return;
                const event = await response.json();
                
                details.innerHTML = `
                    <div class="detail-section">
                        <h3>Basic Information</h3>
                        <div class="detail-grid">
                            <div>
                                <p><strong>Timestamp:</strong> ${formatTimestamp(event.timestamp)}</p>
                                <p><strong>Event Type:</strong> ${event.event_type}</p>
                                <p><strong>Severity:</strong> <span class="badge severity-${event.severity}">${event.severity}</span></p>
                                <p><strong>Path:</strong> ${event.path}</p>
                                ${event.old_path ? `<p><strong>Old Path:</strong> ${event.old_path}</p>` : ''}
                            </div>
                            <div>
                                <p><strong>Risk Score:</strong> ${event.risk_score !== null ? event.risk_score : 'N/A'}</p>
                                <p><strong>AI Risk Score:</strong> ${event.ai_risk_score !== null ? event.ai_risk_score : 'N/A'}</p>
                                <p><strong>Content Score:</strong> ${event.content_score !== null ? event.content_score : 'N/A'}</p>
                                <p><strong>Alert:</strong> ${event.alert ? '<span class="badge alert">YES</span>' : 'No'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Content Classification</h3>
                        <p><strong>Classification:</strong> ${event.content_classification ? 
                            `<span class="badge classification-${event.content_classification}">${event.content_classification}</span>` : 
                            'N/A'}</p>
                        ${event.classification_matches && event.classification_matches.length > 0 ? 
                            `<p><strong>Matched Keywords:</strong> ${event.classification_matches.join(', ')}</p>` : ''}
                        ${event.content_flags && event.content_flags.length > 0 ? 
                            `<p><strong>Content Flags:</strong> ${event.content_flags.join(', ')}</p>` : ''}
                    </div>

                    <div class="detail-section">
                        <h3>Security Context</h3>
                        <div class="detail-grid">
                            <div>
                                <p><strong>User:</strong> ${event.user || 'N/A'}</p>
                                <p><strong>User Type:</strong> ${event.user_type || 'N/A'}</p>
                                <p><strong>Process:</strong> ${event.process_name || 'N/A'}</p>
                            </div>
                            <div>
                                <p><strong>Hash Changed:</strong> ${event.hash_changed ? 'Yes' : 'No'}</p>
                                <p><strong>First Seen:</strong> ${event.first_seen !== null ? (event.first_seen ? 'Yes' : 'No') : 'N/A'}</p>
                                <p><strong>Admin Approval:</strong> ${event.requires_admin_approval ? 
                                    (event.admin_approved ? 'Approved' : 'Pending') : 'Not Required'}</p>
                            </div>
                        </div>
                    </div>

                    ${event.mitre_tags && event.mitre_tags.length > 0 ? `
                    <div class="detail-section">
                        <h3>MITRE ATT&CK</h3>
                        <ul>
                            ${event.mitre_tags.map(tag => `<li>${tag}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}

                    <div class="detail-section">
                        <h3>File Hashes</h3>
                        <div class="detail-grid">
                            <div>
                                <p><strong>SHA256:</strong></p>
                                <p style="font-family: monospace; font-size: 12px; word-break: break-all;">${event.sha256 || 'N/A'}</p>
                            </div>
                            <div>
                                <p><strong>Previous SHA256:</strong></p>
                                <p style="font-family: monospace; font-size: 12px; word-break: break-all;">${event.previous_sha256 || 'N/A'}</p>
                            </div>
                        </div>
                    </div>

                    <div class="ai-remediation-card" id="ai-remediation-card" style="display: none;">
                        <div class="ai-remediation-header">
                            <span class="ai-remediation-icon">🤖</span>
                            <span class="ai-remediation-title">AI Remediation Recommendation</span>
                        </div>
                        <p class="ai-remediation-text" id="ai-remediation-text"></p>
                    </div>

                    ${event.ai_classification || event.ai_risk_reason ? `
                    <div class="detail-section">
                        <h3>AI Analysis</h3>
                        ${event.ai_classification ? `<p><strong>Classification:</strong> ${event.ai_classification}</p>` : ''}
                        ${event.ai_risk_reason ? `<p><strong>Risk Reason:</strong> ${event.ai_risk_reason}</p>` : ''}
                    </div>
                    ` : ''}

                    <div class="detail-section">
                        <h3>Message</h3>
                        <p>${event.message || 'N/A'}</p>
                    </div>

                    <div id="admin-approval-panel" class="admin-approval-panel" style="display:none;">
                        <h4>Admin approval required</h4>
                        <p>This event modified a sensitive/private file. Enter the admin password to approve.</p>
                        <input type="password" id="admin-approval-password-inline" placeholder="Admin password" />
                        <div id="admin-approval-error" class="error-message" style="display:none;"></div>
                        <div class="modal-actions">
                            <button id="admin-approve-btn" class="btn btn-primary">Approve</button>
                        </div>
                    </div>
                `;
                
                // Set current event for admin approval
                currentEvent = event;
                
                // Handle AI remediation recommendation
                const aiBox = document.getElementById("ai-remediation-card");
                const aiText = document.getElementById("ai-remediation-text");
                if (event.ai_recommendation) {
                    if (aiBox) aiBox.style.display = "block";
                    if (aiText) aiText.textContent = event.ai_recommendation;
                } else {
                    if (aiBox) aiBox.style.display = "none";
                    if (aiText) aiText.textContent = "";
                }

                // Handle admin approval panel
                const adminPanel = document.getElementById("admin-approval-panel");
                if (event.requires_admin_approval && event.admin_approved === null) {
                    if (adminPanel) adminPanel.style.display = "block";
                } else {
                    if (adminPanel) adminPanel.style.display = "none";
                }

                // Wire up admin approve button
                const approveBtn = document.getElementById("admin-approve-btn");
                if (approveBtn) {
                    approveBtn.onclick = submitAdminApproval;
                }
            } catch (error) {
                console.error('Error loading event details:', error);
                details.innerHTML = '<div class="error">Failed to load event details</div>';
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('event-modal').classList.remove('active');
            currentEvent = null;
        }

        // Submit admin approval
        async function submitAdminApproval() {
            if (!currentEvent) return;
            const pwdInput = document.getElementById("admin-approval-password-inline");
            const errorBox = document.getElementById("admin-approval-error");
            const password = pwdInput ? pwdInput.value : "";

            if (!password) {
                if (errorBox) {
                    errorBox.style.display = "block";
                    errorBox.textContent = "Password is required";
                }
                return;
            }

            try {
                const res = await fetch(`/api/admin/approve/${currentEvent.id}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify({ password: password, approve: true })
                });

                if (!res.ok) {
                    const data = await res.json().catch(() => ({}));
                    if (errorBox) {
                        errorBox.style.display = "block";
                        errorBox.textContent = data.detail || "Approval failed";
                    }
                    return;
                }

                if (errorBox) {
                    errorBox.style.display = "none";
                    errorBox.textContent = "";
                }
                if (pwdInput) pwdInput.value = "";
                
                // Mark as approved in UI
                currentEvent.admin_approved = true;
                const adminPanel = document.getElementById("admin-approval-panel");
                if (adminPanel) adminPanel.style.display = "none";
                
                // Reload events table so the "Needs approval" badge disappears
                await loadEvents("?limit=100");
            } catch (err) {
                console.error(err);
                if (errorBox) {
                    errorBox.style.display = "block";
                    errorBox.textContent = "Network error while approving";
                }
            }
        }

        // Close modal on outside click
        document.getElementById('event-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Utility functions
        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        function truncatePath(path, maxLength = 50) {
            if (path.length <= maxLength) return path;
            return '...' + path.slice(-maxLength + 3);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Setup events tab filters
        function setupEventsTabFilters() {
            const severityFilter = document.getElementById('events-severity-filter');
            const classificationFilter = document.getElementById('events-classification-filter');
            const pathSearch = document.getElementById('events-path-search');
            const limitSelect = document.getElementById('events-limit');
            
            if (severityFilter) severityFilter.addEventListener('change', loadEventsFull);
            if (classificationFilter) classificationFilter.addEventListener('change', loadEventsFull);
            if (pathSearch) pathSearch.addEventListener('input', debounce(loadEventsFull, 300));
            if (limitSelect) limitSelect.addEventListener('change', loadEventsFull);
        }

        // Render timeline events
        function renderTimelineEvents(events) {
            const timeline = document.getElementById('timeline');
            if (!timeline) return;
            
            timeline.innerHTML = '';

            if (events.length === 0) {
                timeline.innerHTML = '<div class="loading">No events found</div>';
                return;
            }

            // Sort by timestamp descending (most recent first)
            const sortedEvents = [...events].sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            sortedEvents.forEach(event => {
                const item = document.createElement('div');
                item.className = `timeline-item severity-${event.severity || 'low'}`;
                const needsApproval = event.requires_admin_approval === true && event.admin_approved === null;
                const approvalBadge = needsApproval ? '<span class="badge badge-warning">Needs approval</span>' : '';
                item.onclick = () => {
                    currentEvent = event;
                    showEventDetails(event.id);
                };
                
                const timestamp = formatTimestamp(event.timestamp);
                const path = truncatePath(event.path, 60);
                const riskScore = event.risk_score !== null ? event.risk_score : '-';
                const alertBadge = event.alert ? '<span class="badge alert">ALERT</span>' : '';
                
                item.innerHTML = `
                    <div class="timeline-left">
                        <span class="timeline-timestamp">${timestamp}</span>
                        <div class="timeline-dot"></div>
                    </div>
                    <div class="timeline-right">
                        <div class="timeline-header">
                            <span class="timeline-event-type">${event.event_type}</span>
                        </div>
                        <div class="timeline-body">
                            <div class="timeline-path">${path}</div>
                            <div class="timeline-meta">
                                <span class="timeline-risk-score">Risk: ${riskScore}</span>
                                ${alertBadge} ${approvalBadge}
                            </div>
                        </div>
                    </div>
                `;
                timeline.appendChild(item);
            });
        }

        // Load timeline for Events tab
        async function loadTimeline(query = "?limit=200") {
            try {
                const response = await fetch('/api/events' + query, {
                    credentials: "include"
                });
                if (response.status === 401) {
                    document.getElementById("login-overlay").style.display = "flex";
                    return;
                }
                if (!response.ok) {
                    const errorDiv = document.getElementById('timeline-error');
                    if (errorDiv) {
                        errorDiv.innerHTML = '<div class="error">Failed to load timeline</div>';
                    }
                    return;
                }
                const data = await response.json();
                eventsCache = data.events || [];
                renderTimelineEvents(eventsCache);
            } catch (error) {
                console.error('Error loading timeline:', error);
                const timeline = document.getElementById('timeline');
                if (timeline) {
                    timeline.innerHTML = '<div class="error">Failed to load timeline</div>';
                }
            }
        }

        // Show events filtered by MITRE tag
        async function showEventsWithMitreTag(tag) {
            // Switch to Events tab
            switchTab('events');
            
            // Update timeline title
            const timelineTitle = document.querySelector('#timeline-container h3');
            if (timelineTitle) {
                timelineTitle.textContent = tag ? `Attacker Timeline — ${tag}` : "Attacker Timeline";
            }

            // Load events if cache is empty
            if (!eventsCache || eventsCache.length === 0) {
                await loadTimeline("?limit=200");
            }

            // Filter by MITRE tag
            const filtered = tag
                ? (eventsCache || []).filter(ev =>
                    (ev.mitre_tags || []).includes(tag)
                  )
                : eventsCache;

            renderTimelineEvents(filtered);
        }

        // Load full events table for Events tab (kept for compatibility)
        async function loadEventsFull() {
            const severity = document.getElementById('events-severity-filter')?.value || '';
            const classification = document.getElementById('events-classification-filter')?.value || '';
            const pathSearch = document.getElementById('events-path-search')?.value || '';
            const limit = document.getElementById('events-limit')?.value || '100';

            const params = new URLSearchParams({ limit: limit });
            if (severity) params.append('severity', severity);
            if (classification) params.append('classification', classification);
            if (pathSearch) params.append('path_filter', pathSearch);

            try {
                const response = await fetch(`/api/events?${params}`, {
                    credentials: "include"
                });
                if (response.status === 401) {
                    document.getElementById("login-overlay").style.display = "flex";
                    return;
                }
                if (!response.ok) return;
                const data = await response.json();
                
                const tbody = document.getElementById('events-full-tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                if (data.events.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="loading">No events found</td></tr>';
                    return;
                }

                data.events.forEach(event => {
                    const row = document.createElement('tr');
                    const needsApproval = event.requires_admin_approval === true && event.admin_approved === null;
                    const approvalBadge = needsApproval ? '<span class="badge badge-warning">Needs approval</span>' : '';
                    row.onclick = () => {
                        currentEvent = event;
                        showEventDetails(event.id);
                    };
                    row.innerHTML = `
                        <td>${formatTimestamp(event.timestamp)}</td>
                        <td>${event.event_type}</td>
                        <td><span class="badge severity-${event.severity}">${event.severity}</span></td>
                        <td>${event.risk_score !== null ? event.risk_score : '-'}</td>
                        <td>${truncatePath(event.path)}</td>
                        <td>${event.content_classification ? 
                            `<span class="badge classification-${event.content_classification}">${event.content_classification}</span>` : 
                            '-'}</td>
                        <td>${event.alert ? '<span class="badge alert">ALERT</span>' : ''} ${approvalBadge}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading events:', error);
                const tbody = document.getElementById('events-full-tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="7" class="error">Failed to load events</td></tr>';
                }
            }
        }

        // Load MITRE data
        async function loadMitreData() {
            try {
                const response = await fetch('/api/events?limit=1000', {
                    credentials: "include"
                });
                if (response.status === 401) {
                    document.getElementById("login-overlay").style.display = "flex";
                    return;
                }
                if (!response.ok) return;
                const data = await response.json();
                
                // Group events by MITRE tag
                const mitreMap = {};
                data.events.forEach(event => {
                    if (event.mitre_tags && event.mitre_tags.length > 0) {
                        event.mitre_tags.forEach(tag => {
                            if (!mitreMap[tag]) {
                                mitreMap[tag] = [];
                            }
                            mitreMap[tag].push(event);
                        });
                    }
                });

                const tbody = document.getElementById('mitre-tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                if (Object.keys(mitreMap).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="loading">No MITRE tags found</td></tr>';
                    return;
                }

                Object.entries(mitreMap).forEach(([tag, events]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${tag}</td>
                        <td>${events.length}</td>
                        <td>
                            <button class="btn-small" data-mitre-tag="${tag}" style="padding: 6px 12px; background-color: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                View Events
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading MITRE data:', error);
                const tbody = document.getElementById('mitre-tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="3" class="error">Failed to load MITRE data</td></tr>';
                }
            }
        }

        // Load agent info
        async function loadAgentInfo() {
            try {
                const response = await fetch('/api/stats/summary', {
                    credentials: "include"
                });
                if (response.ok) {
                    // Hostname would come from API if available
                    const hostnameEl = document.getElementById('agent-hostname');
                    if (hostnameEl) {
                        hostnameEl.textContent = window.location.hostname || 'localhost';
                    }
                }
            } catch (error) {
                const hostnameEl = document.getElementById('agent-hostname');
                if (hostnameEl) {
                    hostnameEl.textContent = 'Unknown';
                }
            }
        }

        // Setup tab navigation
        function setupTabNavigation() {
            const navLinks = document.querySelectorAll('.sidebar nav a');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    switchTab(page);
                });
            });
        }

        // Switch tabs
        function switchTab(page) {
            // Update active nav link
            document.querySelectorAll('.sidebar nav a').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-page') === page) {
                    link.classList.add('active');
                }
            });

            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            const selectedTab = document.getElementById(`tab-${page}`);
            if (selectedTab) {
                selectedTab.classList.add('active');
                
                // Load tab-specific data
                if (page === 'events') {
                    // Reset timeline title when switching to events tab normally
                    const timelineTitle = document.querySelector('#timeline-container h3');
                    if (timelineTitle) {
                        timelineTitle.textContent = "Attacker Timeline";
                    }
                    loadTimeline();
                } else if (page === 'mitre') {
                    loadMitreData();
                } else if (page === 'agents') {
                    loadAgentInfo();
                }
            }
        }
    </script>
</body>
</html>

